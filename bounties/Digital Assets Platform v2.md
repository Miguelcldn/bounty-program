![alt text](https://github.com/bitDubai/media-kit/blob/master/MediaKit/Fermat%20Branding/Fermat%20Logotype/Fermat_Logo_3D.png "Fermat Logo")

# Digital Asset Platform v2 Bounty

## Introduction

After [previous bounty] (link a previous bounty) was completed, new needs have raised the priority to introduce changes and improvements to DAP platform. This document describes the scope, design and timeline of the new bounty.

## Scope

### Current developments in progress

In the present, DAP is being changed and improved in the following way:

* Changes to Community Apps: actually no authorization is requested for connections between DAP actors. Asset Issuer, Asset User and Redeem Point community apps will me modified to perform connections only after authorization is received. [Issue #4692 on Github](https://github.com/bitDubai/fermat/issues/4692)

* Multiple network selection: all DAP wallets and sub apps will allow the selection of the NetworkType (MainNet, TestNet and RegTestNet) while all processes and transactions must still continue working as expected. [Issue #4693 on Github](https://github.com/bitDubai/fermat/issues/4693)

* Wallets GUI small improvements: we are enhancing the user experience by adding Search options, filter of data for assets with no positive balance, etc. [Issue #4694 on Github](https://github.com/bitDubai/fermat/issues/4694)

* BCH layer changes to support all network types: changes to BCH to support transactions in any network concurrently. [Issue #4658 on Github](https://github.com/bitDubai/fermat/issues/4658)

* Chat platform implementation: the team is involved in fixing issues on CHT platform to reach the demo ASAP. [Issue #4234 on Github](https://github.com/bitDubai/fermat/issues/4234)


### Bounty scope

#### New Transaction: Assets Transference.

This transaction will be used to transfer assets between users (Asset User --> Asset User). Current existing transactions regarding distribution only involves Asset Issuer --> Asset User actors.

* Changes to Asset User Wallet: 
    * new button will be added called "Transfer Asset" that will open a new window to allow selection of users to transfer the asset to.
    * new screen that will get the connected Users by the Asset User Community app
    
* New transactional plugin **Asset User Transference** which will handle the transaction steps to transfer the asset with all security needed.

* Changes to **Asset Reception** to allow receiving assets from Issuer *and* User actors.
    
#### New Transaction: Asset Exchange.

This transaction will allow the exchange of Assets between users (Asset User --> Asset User), allowing them to buy and sell assets.

The Asset Exchange transaction will be started by the *Asset Seller*, by sending the *Asset Buyer* the *Asset Metadata* only. This special metadata will be identified by the *Asset Buyer* as an Asset Exchange transaction and will display the received asset as an Asset to buy. Among the basic Asset data, the metadata will include the cost of the asset and the available quantity to purchase.

Using the **Asset Transmission** Network Service, the buyer will deliver an *Empty* asset for the buyer to review it with cost and quantuty information, and confirm or deny the exchange operation.

Confirmation or denial of exchange operation will be transmitted using the **Actor Asset User** Network Service designing a new *exchangeConfirmation* message.

If exchange confiirmation is approved, the next steps are to perform the payment and Asset tranference transactions as securely as possible using multi signature bitcoin transactions:

1. Each exchange participant will send the other a Public Key generated by the respective vault. (Asset Seller from Bitcoin Vault, Asset Buyer from Asset Vault). This public Key will be transmitted with the *Actor Asset User* Network Service with a new message type (*exchangePublicKey* DAP message type).

2. Each exchange participant will generate a new bitcoin transaction using their own funds as inputs and a **Multi Signature output** using both keys. After creation this transactions will be broadcasted to the network.

    The *Asset Seller* will use the asset bitcoins as input, and create an output valid for both public Keys, and the *Asset Buyer* will use the agreed exchange costs to generate the transaction from his Bitcoin wallet with the same output. 

3. After transactions have been confirmed, each participant will notify the other of the Transaction Hash and the block hash of each transaction and each participant will validate they are correct.

    Validation will include that the created transaction by earch actor has the correct bitcoin amount and that the keys correspond to each other.

4. Once validation is complete, they will create signatures for the transactions they are receiving funds from and send the signatures to the other participant.

5. Each participant will create a new transaction using the previous broadcasted transaction as input and will complete the signing with their own sign on the transaction. Each participant will broadcast the transactions and wait for the incomig one that will end the process.

6. When payment is received by *Asset Seller* will be added to the **Bitcoin Wallet** and asset will generate a credit in the **Asset User Wallet** as usual.

The following table describes the process with an example:

| Step | Asset Seller | Asset Buyer |
|:---:|:---|---:|
|1|Selects Asset to sell and specifies Exchange Metadata. Asset Cost 1BTC | Receives asset to buy|
|2| Recieves exchange confirmation from buyer | Receives asset information and confirms operation of buying at 1BTC.|
|3| Generates PublicKey in Bitcoin Vault | Generates public Key in Asset Vault|
|4| Sends public Key to buyer with NS | Sends public Key to seller with NS|
|5| Generates Tran. A with own inputs for GenesisAmount and multi sig output | Generates Tran. B with own inputs for 1 BTC and multi sig output|
|6| Broadcast tran A and waits confirmation | Broadcast tran B and waits confirmation|
|7| Send to buyer tx Hash and block Hash of Tran A with NS | Send to seller tx Hash and block Hash of Tran B with NS|
|8| Validate existence of Tran B in blockchain with correct value and outputs| Validate existence of Tran A in blockchain with correct value and outputs|
|9| Generates new Transaction C with Tran A as input and output for buyer address| Generates new Transaction D with Tran B as input and output for seller address|
|10| Signs transaction C and send signature to buyer using NS| Signs transaction D and send signature to seller using NS|
|11| Recreates same transaction D and apply both signatures | Recreates same transaction C and apply both signatures|
|12| Broadcast transaction D | Broadcast Transaction C|
|13| Detects transaction and perform credit in Bitcoin Wallet | Detects transaction and performs credit in Asset User Wallet.|

---

Changes to implement for this new transaction are:

* **Asset User Wallet** changes to allow an user to sell an asset.
* new transaction plugin **Asset Exchange Asset User Buyer** to handle the transaction in the buyer role.
* new transaction plugin **Asset Exchange Asset User Seller** to handle the transaction in the seller role.
* new DAP Messages to transfer data between users on the **Actor Asset User** network service. This network Service must allow retries and cancellation of messages.
* Changes to Bitcoin and Asset Vaults to support the bitcoins transactions.
* New Exchange Asset Metadata that extends the original Asset Metadata class which includes Asset Cost, exchange expiration date, amount of assets to sell.
* Changes to *Asset Transmission* network Service, to allow the transmission of *Exchange Asset Metadata* information

***Once approved, the design will be completed in dev.fermat.org flows with much more detail***
     

## Timeline

Based on current workload and resouces available, the delivery date of this bounty will be **March 15th**.

## Evaluation

To be considered success this bounty must pass the following tests:

* Distribute between users an asset in any network.
* Exchange an asset between users in any network.
* The combination of any possible allowed behaviour by the applications without generating errors that doesn't allow to continue the evaluation.

*[Evaluation results to be completed after evaluation]*

## Distribution

*[Distribution to be completed after evaluation]*

